import { D2R, R2D, A, MAXEXTENT, SPHERICAL_MERCATOR_SRS, WGS84, } from './constants';
const cache = {};
function isFloat(n) {
    return Number(n) === n && n % 1 !== 0;
}
export class SphericalMercator {
    #size;
    #expansion;
    #Bc;
    #Cc;
    #zc;
    #Ac;
    constructor(options = {}) {
        this.#size = options.size || 256;
        this.#expansion = options.antimeridian ? 2 : 1;
        if (!cache[this.#size]) {
            let size = this.#size;
            const c = (cache[this.#size] = {});
            c.Bc = [];
            c.Cc = [];
            c.zc = [];
            c.Ac = [];
            for (let d = 0; d < 30; d++) {
                c.Bc.push(size / 360);
                c.Cc.push(size / (2 * Math.PI));
                c.zc.push(size / 2);
                c.Ac.push(size);
                size *= 2;
            }
        }
        this.#Bc = cache[this.#size].Bc;
        this.#Cc = cache[this.#size].Cc;
        this.#zc = cache[this.#size].zc;
        this.#Ac = cache[this.#size].Ac;
    }
    px(ll, zoom) {
        if (isFloat(zoom)) {
            const size = this.#size * Math.pow(2, zoom);
            const d = size / 2;
            const bc = size / 360;
            const cc = size / (2 * Math.PI);
            const ac = size;
            const f = Math.min(Math.max(Math.sin(D2R * ll[1]), -0.9999), 0.9999);
            let x = d + ll[0] * bc;
            let y = d + 0.5 * Math.log((1 + f) / (1 - f)) * -cc;
            x > ac * this.#expansion && (x = ac * this.#expansion);
            y > ac && (y = ac);
            //(x < 0) && (x = 0);
            //(y < 0) && (y = 0);
            return [x, y];
        }
        else {
            const d = this.#zc[zoom];
            const f = Math.min(Math.max(Math.sin(D2R * ll[1]), -0.9999), 0.9999);
            let x = Math.round(d + ll[0] * this.#Bc[zoom]);
            let y = Math.round(d + 0.5 * Math.log((1 + f) / (1 - f)) * -this.#Cc[zoom]);
            x > this.#Ac[zoom] * this.#expansion &&
                (x = this.#Ac[zoom] * this.#expansion);
            y > this.#Ac[zoom] && (y = this.#Ac[zoom]);
            //(x < 0) && (x = 0);
            //(y < 0) && (y = 0);
            return [x, y];
        }
    }
    ll(px, zoom) {
        if (isFloat(zoom)) {
            const size = this.#size * Math.pow(2, zoom);
            const bc = size / 360;
            const cc = size / (2 * Math.PI);
            const zc = size / 2;
            const g = (px[1] - zc) / -cc;
            const lon = (px[0] - zc) / bc;
            const lat = R2D * (2 * Math.atan(Math.exp(g)) - 0.5 * Math.PI);
            return [lon, lat];
        }
        else {
            const g = (px[1] - this.#zc[zoom]) / -this.#Cc[zoom];
            const lon = (px[0] - this.#zc[zoom]) / this.#Bc[zoom];
            const lat = R2D * (2 * Math.atan(Math.exp(g)) - 0.5 * Math.PI);
            return [lon, lat];
        }
    }
    convert(bbox, to) {
        if (to === SPHERICAL_MERCATOR_SRS) {
            return [
                ...this.forward(bbox.slice(0, 2)),
                ...this.forward(bbox.slice(2, 4)),
            ];
        }
        else {
            return [
                ...this.inverse(bbox.slice(0, 2)),
                ...this.inverse(bbox.slice(2, 4)),
            ];
        }
    }
    inverse(xy) {
        return [
            (xy[0] * R2D) / A,
            (Math.PI * 0.5 - 2.0 * Math.atan(Math.exp(-xy[1] / A))) * R2D,
        ];
    }
    forward(ll) {
        const xy = [
            A * ll[0] * D2R,
            A * Math.log(Math.tan(Math.PI * 0.25 + 0.5 * ll[1] * D2R)),
        ];
        // if xy value is beyond maxextent (e.g. poles), return maxextent.
        xy[0] > MAXEXTENT && (xy[0] = MAXEXTENT);
        xy[0] < -MAXEXTENT && (xy[0] = -MAXEXTENT);
        xy[1] > MAXEXTENT && (xy[1] = MAXEXTENT);
        xy[1] < -MAXEXTENT && (xy[1] = -MAXEXTENT);
        return xy;
    }
    bbox(x, y, zoom, tmsStyle, srs) {
        // Convert xyz into bbox with srs WGS84
        if (tmsStyle) {
            y = Math.pow(2, zoom) - 1 - y;
        }
        // Use +y to make sure it's a number to avoid inadvertent concatenation.
        const ll = [x * this.#size, (+y + 1) * this.#size]; // lower left
        // Use +x to make sure it's a number to avoid inadvertent concatenation.
        const ur = [(+x + 1) * this.#size, y * this.#size]; // upper right
        const bbox = [...this.ll(ll, zoom), ...this.ll(ur, zoom)];
        // If web mercator requested reproject to 900913.
        if (srs === SPHERICAL_MERCATOR_SRS)
            return this.convert(bbox, SPHERICAL_MERCATOR_SRS);
        return bbox;
    }
    xyz(bbox, zoom, tmsStyle, srs) {
        // If web mercator provided reproject to WGS84.
        const box = srs === SPHERICAL_MERCATOR_SRS ? this.convert(bbox, WGS84) : bbox;
        const ll = [box[0], box[1]]; // lower left
        const ur = [box[2], box[3]]; // upper right
        const px_ll = this.px(ll, zoom);
        const px_ur = this.px(ur, zoom);
        // Y = 0 for XYZ is the top hence minY uses px_ur[1].
        const x = [
            Math.floor(px_ll[0] / this.#size),
            Math.floor((px_ur[0] - 1) / this.#size),
        ];
        const y = [
            Math.floor(px_ur[1] / this.#size),
            Math.floor((px_ll[1] - 1) / this.#size),
        ];
        const bounds = {
            minX: Math.min.apply(Math, x) < 0 ? 0 : Math.min.apply(Math, x),
            minY: Math.min.apply(Math, y) < 0 ? 0 : Math.min.apply(Math, y),
            maxX: Math.max.apply(Math, x),
            maxY: Math.max.apply(Math, y),
        };
        if (tmsStyle) {
            const tms = {
                minY: Math.pow(2, zoom) - 1 - bounds.maxY,
                maxY: Math.pow(2, zoom) - 1 - bounds.minY,
            };
            bounds.minY = tms.minY;
            bounds.maxY = tms.maxY;
        }
        return bounds;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLEdBQUcsRUFDSCxHQUFHLEVBQ0gsQ0FBQyxFQUNELFNBQVMsRUFDVCxzQkFBc0IsRUFDdEIsS0FBSyxHQUNOLE1BQU0sYUFBYSxDQUFDO0FBd0JyQixNQUFNLEtBQUssR0FBcUIsRUFBRSxDQUFDO0FBQ25DLFNBQVMsT0FBTyxDQUFDLENBQVM7SUFDeEIsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3hDLENBQUM7QUFFRCxNQUFNLE9BQU8saUJBQWlCO0lBQzVCLEtBQUssQ0FBUztJQUNkLFVBQVUsQ0FBUTtJQUNsQixHQUFHLENBQVc7SUFDZCxHQUFHLENBQVc7SUFDZCxHQUFHLENBQVc7SUFDZCxHQUFHLENBQVc7SUFFZCxZQUFZLFVBQW1CLEVBQUU7UUFDL0IsSUFBSSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxJQUFJLEdBQUcsQ0FBQztRQUNqQyxJQUFJLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRS9DLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDdkIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUN0QixNQUFNLENBQUMsR0FBcUIsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ3JELENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1lBQ1YsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7WUFDVixDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUNW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QUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztTQUN4QyxDQUFDO1FBQ0YsTUFBTSxDQUFDLEdBQUc7WUFDUixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztTQUN4QyxDQUFDO1FBQ0YsTUFBTSxNQUFNLEdBQUc7WUFDYixJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQy9ELElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7WUFDL0QsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7WUFDN0IsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7U0FDOUIsQ0FBQztRQUNGLElBQUksUUFBUSxFQUFFLENBQUM7WUFDYixNQUFNLEdBQUcsR0FBRztnQkFDVixJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJO2dCQUN6QyxJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJO2FBQzFDLENBQUM7WUFDRixNQUFNLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDdkIsTUFBTSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3pCLENBQUM7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEMlIsXG4gIFIyRCxcbiAgQSxcbiAgTUFYRVhURU5ULFxuICBTUEhFUklDQUxfTUVSQ0FUT1JfU1JTLFxuICBXR1M4NCxcbn0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5pbnRlcmZhY2UgT3B0aW9ucyB7XG4gIHNpemU/OiBudW1iZXI7XG4gIGFudGltZXJpZGlhbj86IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBYWVoge1xuICBtaW5YOiBudW1iZXI7XG4gIG1heFg6IG51bWJlcjtcbiAgbWluWTogbnVtYmVyO1xuICBtYXhZOiBudW1iZXI7XG59XG5cbnR5cGUgWFkgPSBbbnVtYmVyLCBudW1iZXJdO1xudHlwZSBMb25MYXQgPSBbbnVtYmVyLCBudW1iZXJdO1xudHlwZSBab29tID0gbnVtYmVyO1xudHlwZSBXZXN0ID0gbnVtYmVyO1xudHlwZSBTb3V0aCA9IG51bWJlcjtcbnR5cGUgRWFzdCA9IG51bWJlcjtcbnR5cGUgTm9ydGggPSBudW1iZXI7XG50eXBlIEJCb3ggPSBbV2VzdCwgU291dGgsIEVhc3QsIE5vcnRoXTtcbnR5cGUgU1JTID0gdHlwZW9mIFNQSEVSSUNBTF9NRVJDQVRPUl9TUlMgfCB0eXBlb2YgV0dTODQ7XG5cbmNvbnN0IGNhY2hlOiBSZWNvcmQ8YW55LCBhbnk+ID0ge307XG5mdW5jdGlvbiBpc0Zsb2F0KG46IG51bWJlcik6IGJvb2xlYW4ge1xuICByZXR1cm4gTnVtYmVyKG4pID09PSBuICYmIG4gJSAxICE9PSAwO1xufVxuXG5leHBvcnQgY2xhc3MgU3BoZXJpY2FsTWVyY2F0b3Ige1xuICAjc2l6ZTogbnVtYmVyO1xuICAjZXhwYW5zaW9uOiAxIHwgMjtcbiAgI0JjOiBudW1iZXJbXTtcbiAgI0NjOiBudW1iZXJbXTtcbiAgI3pjOiBudW1iZXJbXTtcbiAgI0FjOiBudW1iZXJbXTtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBPcHRpb25zID0ge30pIHtcbiAgICB0aGlzLiNzaXplID0gb3B0aW9ucy5zaXplIHx8IDI1NjtcbiAgICB0aGlzLiNleHBhbnNpb24gPSBvcHRpb25zLmFudGltZXJpZGlhbiA/IDIgOiAxO1xuXG4gICAgaWYgKCFjYWNoZVt0aGlzLiNzaXplXSkge1xuICAgICAgbGV0IHNpemUgPSB0aGlzLiNzaXplO1xuICAgICAgY29uc3QgYzogUmVjb3JkPGFueSwgYW55PiA9IChjYWNoZVt0aGlzLiNzaXplXSA9IHt9KTtcbiAgICAgIGMuQmMgPSBbXTtcbiAgICAgIGMuQ2MgPSBbXTtcbiAgICAgIGMuemMgPSBbXTtcbiAgICAgIGMuQWMgPSBbXTtcbiAgICAgIGZvciAobGV0IGQgPSAwOyBkIDwgMzA7IGQrKykge1xuICAgICAgICBjLkJjLnB1c2goc2l6ZSAvIDM2MCk7XG4gICAgICAgIGMuQ2MucHVzaChzaXplIC8gKDIgKiBNYXRoLlBJKSk7XG4gICAgICAgIGMuemMucHVzaChzaXplIC8gMik7XG4gICAgICAgIGMuQWMucHVzaChzaXplKTtcbiAgICAgICAgc2l6ZSAqPSAyO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLiNCYyA9IGNhY2hlW3RoaXMuI3NpemVdLkJjO1xuICAgIHRoaXMuI0NjID0gY2FjaGVbdGhpcy4jc2l6ZV0uQ2M7XG4gICAgdGhpcy4jemMgPSBjYWNoZVt0aGlzLiNzaXplXS56YztcbiAgICB0aGlzLiNBYyA9IGNhY2hlW3RoaXMuI3NpemVdLkFjO1xuICB9XG5cbiAgcHVibGljIHB4KGxsOiBMb25MYXQsIHpvb206IFpvb20pOiBYWSB7XG4gICAgaWYgKGlzRmxvYXQoem9vbSkpIHtcbiAgICAgIGNvbnN0IHNpemUgPSB0aGlzLiNzaXplICogTWF0aC5wb3coMiwgem9vbSk7XG4gICAgICBjb25zdCBkID0gc2l6ZSAvIDI7XG4gICAgICBjb25zdCBiYyA9IHNpemUgLyAzNjA7XG4gICAgICBjb25zdCBjYyA9IHNpemUgLyAoMiAqIE1hdGguUEkpO1xuICAgICAgY29uc3QgYWMgPSBzaXplO1xuICAgICAgY29uc3QgZiA9IE1hdGgubWluKE1hdGgubWF4KE1hdGguc2luKEQyUiAqIGxsWzFdKSwgLTAuOTk5OSksIDAuOTk5OSk7XG4gICAgICBsZXQgeCA9IGQgKyBsbFswXSAqIGJjO1xuICAgICAgbGV0IHkgPSBkICsgMC41ICogTWF0aC5sb2coKDEgKyBmKSAvICgxIC0gZikpICogLWNjO1xuICAgICAgeCA+IGFjICogdGhpcy4jZXhwYW5zaW9uICYmICh4ID0gYWMgKiB0aGlzLiNleHBhbnNpb24pO1xuICAgICAgeSA+IGFjICYmICh5ID0gYWMpO1xuICAgICAgLy8oeCA8IDApICYmICh4ID0gMCk7XG4gICAgICAvLyh5IDwgMCkgJiYgKHkgPSAwKTtcbiAgICAgIHJldHVybiBbeCwgeV07XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGQgPSB0aGlzLiN6Y1t6b29tXTtcbiAgICAgIGNvbnN0IGYgPSBNYXRoLm1pbihNYXRoLm1heChNYXRoLnNpbihEMlIgKiBsbFsxXSksIC0wLjk5OTkpLCAwLjk5OTkpO1xuICAgICAgbGV0IHggPSBNYXRoLnJvdW5kKGQgKyBsbFswXSAqIHRoaXMuI0JjW3pvb21dKTtcbiAgICAgIGxldCB5ID0gTWF0aC5yb3VuZChcbiAgICAgICAgZCArIDAuNSAqIE1hdGgubG9nKCgxICsgZikgLyAoMSAtIGYpKSAqIC10aGlzLiNDY1t6b29tXSxcbiAgICAgICk7XG4gICAgICB4ID4gdGhpcy4jQWNbem9vbV0gKiB0aGlzLiNleHBhbnNpb24gJiZcbiAgICAgICAgKHggPSB0aGlzLiNBY1t6b29tXSAqIHRoaXMuI2V4cGFuc2lvbik7XG4gICAgICB5ID4gdGhpcy4jQWNbem9vbV0gJiYgKHkgPSB0aGlzLiNBY1t6b29tXSk7XG4gICAgICAvLyh4IDwgMCkgJiYgKHggPSAwKTtcbiAgICAgIC8vKHkgPCAwKSAmJiAoeSA9IDApO1xuICAgICAgcmV0dXJuIFt4LCB5XTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbGwocHg6IFhZLCB6b29tOiBab29tKTogTG9uTGF0IHtcbiAgICBpZiAoaXNGbG9hdCh6b29tKSkge1xuICAgICAgY29uc3Qgc2l6ZSA9IHRoaXMuI3NpemUgKiBNYXRoLnBvdygyLCB6b29tKTtcbiAgICAgIGNvbnN0IGJjID0gc2l6ZSAvIDM2MDtcbiAgICAgIGNvbnN0IGNjID0gc2l6ZSAvICgyICogTWF0aC5QSSk7XG4gICAgICBjb25zdCB6YyA9IHNpemUgLyAyO1xuICAgICAgY29uc3QgZyA9IChweFsxXSAtIHpjKSAvIC1jYztcbiAgICAgIGNvbnN0IGxvbiA9IChweFswXSAtIHpjKSAvIGJjO1xuICAgICAgY29uc3QgbGF0ID0gUjJEICogKDIgKiBNYXRoLmF0YW4oTWF0aC5leHAoZykpIC0gMC41ICogTWF0aC5QSSk7XG4gICAgICByZXR1cm4gW2xvbiwgbGF0XTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZyA9IChweFsxXSAtIHRoaXMuI3pjW3pvb21dKSAvIC10aGlzLiNDY1t6b29tXTtcbiAgICAgIGNvbnN0IGxvbiA9IChweFswXSAtIHRoaXMuI3pjW3pvb21dKSAvIHRoaXMuI0JjW3pvb21dO1xuICAgICAgY29uc3QgbGF0ID0gUjJEICogKDIgKiBNYXRoLmF0YW4oTWF0aC5leHAoZykpIC0gMC41ICogTWF0aC5QSSk7XG4gICAgICByZXR1cm4gW2xvbiwgbGF0XTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY29udmVydChiYm94OiBCQm94LCB0bzogU1JTKTogQkJveCB7XG4gICAgaWYgKHRvID09PSBTUEhFUklDQUxfTUVSQ0FUT1JfU1JTKSB7XG4gICAgICByZXR1cm4gW1xuICAgICAgICAuLi50aGlzLmZvcndhcmQoYmJveC5zbGljZSgwLCAyKSBhcyBMb25MYXQpLFxuICAgICAgICAuLi50aGlzLmZvcndhcmQoYmJveC5zbGljZSgyLCA0KSBhcyBMb25MYXQpLFxuICAgICAgXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAgLi4udGhpcy5pbnZlcnNlKGJib3guc2xpY2UoMCwgMikgYXMgWFkpLFxuICAgICAgICAuLi50aGlzLmludmVyc2UoYmJveC5zbGljZSgyLCA0KSBhcyBYWSksXG4gICAgICBdO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpbnZlcnNlKHh5OiBYWSk6IExvbkxhdCB7XG4gICAgcmV0dXJuIFtcbiAgICAgICh4eVswXSAqIFIyRCkgLyBBLFxuICAgICAgKE1hdGguUEkgKiAwLjUgLSAyLjAgKiBNYXRoLmF0YW4oTWF0aC5leHAoLXh5WzFdIC8gQSkpKSAqIFIyRCxcbiAgICBdO1xuICB9XG5cbiAgcHVibGljIGZvcndhcmQobGw6IExvbkxhdCk6IFhZIHtcbiAgICBjb25zdCB4eTogTG9uTGF0ID0gW1xuICAgICAgQSAqIGxsWzBdICogRDJSLFxuICAgICAgQSAqIE1hdGgubG9nKE1hdGgudGFuKE1hdGguUEkgKiAwLjI1ICsgMC41ICogbGxbMV0gKiBEMlIpKSxcbiAgICBdO1xuICAgIC8vIGlmIHh5IHZhbHVlIGlzIGJleW9uZCBtYXhleHRlbnQgKGUuZy4gcG9sZXMpLCByZXR1cm4gbWF4ZXh0ZW50LlxuICAgIHh5WzBdID4gTUFYRVhURU5UICYmICh4eVswXSA9IE1BWEVYVEVOVCk7XG4gICAgeHlbMF0gPCAtTUFYRVhURU5UICYmICh4eVswXSA9IC1NQVhFWFRFTlQpO1xuICAgIHh5WzFdID4gTUFYRVhURU5UICYmICh4eVsxXSA9IE1BWEVYVEVOVCk7XG4gICAgeHlbMV0gPCAtTUFYRVhURU5UICYmICh4eVsxXSA9IC1NQVhFWFRFTlQpO1xuICAgIHJldHVybiB4eTtcbiAgfVxuXG4gIHB1YmxpYyBiYm94KFxuICAgIHg6IG51bWJlcixcbiAgICB5OiBudW1iZXIsXG4gICAgem9vbTogWm9vbSxcbiAgICB0bXNTdHlsZT86IGJvb2xlYW4sXG4gICAgc3JzPzogc3RyaW5nLFxuICApOiBCQm94IHtcbiAgICAvLyBDb252ZXJ0IHh5eiBpbnRvIGJib3ggd2l0aCBzcnMgV0dTODRcbiAgICBpZiAodG1zU3R5bGUpIHtcbiAgICAgIHkgPSBNYXRoLnBvdygyLCB6b29tKSAtIDEgLSB5O1xuICAgIH1cbiAgICAvLyBVc2UgK3kgdG8gbWFrZSBzdXJlIGl0J3MgYSBudW1iZXIgdG8gYXZvaWQgaW5hZHZlcnRlbnQgY29uY2F0ZW5hdGlvbi5cbiAgICBjb25zdCBsbDogTG9uTGF0ID0gW3ggKiB0aGlzLiNzaXplLCAoK3kgKyAxKSAqIHRoaXMuI3NpemVdOyAvLyBsb3dlciBsZWZ0XG4gICAgLy8gVXNlICt4IHRvIG1ha2Ugc3VyZSBpdCdzIGEgbnVtYmVyIHRvIGF2b2lkIGluYWR2ZXJ0ZW50IGNvbmNhdGVuYXRpb24uXG4gICAgY29uc3QgdXI6IExvbkxhdCA9IFsoK3ggKyAxKSAqIHRoaXMuI3NpemUsIHkgKiB0aGlzLiNzaXplXTsgLy8gdXBwZXIgcmlnaHRcbiAgICBjb25zdCBiYm94OiBCQm94ID0gWy4uLnRoaXMubGwobGwsIHpvb20pLCAuLi50aGlzLmxsKHVyLCB6b29tKV07XG5cbiAgICAvLyBJZiB3ZWIgbWVyY2F0b3IgcmVxdWVzdGVkIHJlcHJvamVjdCB0byA5MDA5MTMuXG4gICAgaWYgKHNycyA9PT0gU1BIRVJJQ0FMX01FUkNBVE9SX1NSUylcbiAgICAgIHJldHVybiB0aGlzLmNvbnZlcnQoYmJveCwgU1BIRVJJQ0FMX01FUkNBVE9SX1NSUyk7XG5cbiAgICByZXR1cm4gYmJveCBhcyBCQm94O1xuICB9XG5cbiAgcHVibGljIHh5eihiYm94OiBCQm94LCB6b29tOiBab29tLCB0bXNTdHlsZT86IGJvb2xlYW4sIHNycz86IFNSUyk6IFhZWiB7XG4gICAgLy8gSWYgd2ViIG1lcmNhdG9yIHByb3ZpZGVkIHJlcHJvamVjdCB0byBXR1M4NC5cbiAgICBjb25zdCBib3ggPVxuICAgICAgc3JzID09PSBTUEhFUklDQUxfTUVSQ0FUT1JfU1JTID8gdGhpcy5jb252ZXJ0KGJib3gsIFdHUzg0KSA6IGJib3g7XG5cbiAgICBjb25zdCBsbDogTG9uTGF0ID0gW2JveFswXSwgYm94WzFdXTsgLy8gbG93ZXIgbGVmdFxuICAgIGNvbnN0IHVyOiBMb25MYXQgPSBbYm94WzJdLCBib3hbM11dOyAvLyB1cHBlciByaWdodFxuICAgIGNvbnN0IHB4X2xsID0gdGhpcy5weChsbCwgem9vbSk7XG4gICAgY29uc3QgcHhfdXIgPSB0aGlzLnB4KHVyLCB6b29tKTtcbiAgICAvLyBZID0gMCBmb3IgWFlaIGlzIHRoZSB0b3AgaGVuY2UgbWluWSB1c2VzIHB4X3VyWzFdLlxuICAgIGNvbnN0IHggPSBbXG4gICAgICBNYXRoLmZsb29yKHB4X2xsWzBdIC8gdGhpcy4jc2l6ZSksXG4gICAgICBNYXRoLmZsb29yKChweF91clswXSAtIDEpIC8gdGhpcy4jc2l6ZSksXG4gICAgXTtcbiAgICBjb25zdCB5ID0gW1xuICAgICAgTWF0aC5mbG9vcihweF91clsxXSAvIHRoaXMuI3NpemUpLFxuICAgICAgTWF0aC5mbG9vcigocHhfbGxbMV0gLSAxKSAvIHRoaXMuI3NpemUpLFxuICAgIF07XG4gICAgY29uc3QgYm91bmRzID0ge1xuICAgICAgbWluWDogTWF0aC5taW4uYXBwbHkoTWF0aCwgeCkgPCAwID8gMCA6IE1hdGgubWluLmFwcGx5KE1hdGgsIHgpLFxuICAgICAgbWluWTogTWF0aC5taW4uYXBwbHkoTWF0aCwgeSkgPCAwID8gMCA6IE1hdGgubWluLmFwcGx5KE1hdGgsIHkpLFxuICAgICAgbWF4WDogTWF0aC5tYXguYXBwbHkoTWF0aCwgeCksXG4gICAgICBtYXhZOiBNYXRoLm1heC5hcHBseShNYXRoLCB5KSxcbiAgICB9O1xuICAgIGlmICh0bXNTdHlsZSkge1xuICAgICAgY29uc3QgdG1zID0ge1xuICAgICAgICBtaW5ZOiBNYXRoLnBvdygyLCB6b29tKSAtIDEgLSBib3VuZHMubWF4WSxcbiAgICAgICAgbWF4WTogTWF0aC5wb3coMiwgem9vbSkgLSAxIC0gYm91bmRzLm1pblksXG4gICAgICB9O1xuICAgICAgYm91bmRzLm1pblkgPSB0bXMubWluWTtcbiAgICAgIGJvdW5kcy5tYXhZID0gdG1zLm1heFk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGJvdW5kcztcbiAgfVxufVxuIl19